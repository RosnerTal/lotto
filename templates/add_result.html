{% extends "base.html" %}

{% block title %}Add Result - Israeli Lottery Predictor{% endblock %}

{% block content %}
<div class="section">
    <h1>Add New Lottery Result</h1>
    
    {% if success %}
    <div class="alert success">
        ‚úì {{ message }}
    </div>
    {% endif %}
    
    {% if error %}
    <div class="alert error">
        ‚úó {{ message }}
    </div>
    {% endif %}

    <div class="fetch-section">
        <h3>üåê Fetch from Official Website</h3>
        <p>Automatically fill the form with the latest result from <a href="https://lottosheli.co.il/results/lotto" target="_blank">lottosheli.co.il</a></p>
        <button type="button" class="btn btn-secondary" onclick="fetchLatestResult()">Fetch Latest Result</button>
        <div id="fetch-status"></div>
    </div>

    <form method="POST" class="add-result-form" id="addResultForm">
        <div class="form-group">
            <label for="draw_number">Draw Number:</label>
            <input type="number" id="draw_number" name="draw_number" 
                   value="{{ next_draw }}" required min="1">
        </div>

        <div class="form-group">
            <label for="draw_date">Draw Date:</label>
            <input type="date" id="draw_date" name="draw_date" required>
        </div>

        <div class="form-section">
            <h3>Main Numbers (1-37)</h3>
            <div class="numbers-input-grid">
                <div class="form-group">
                    <label for="number1">Number 1:</label>
                    <input type="number" id="number1" name="number1" 
                           required min="1" max="37">
                </div>
                <div class="form-group">
                    <label for="number2">Number 2:</label>
                    <input type="number" id="number2" name="number2" 
                           required min="1" max="37">
                </div>
                <div class="form-group">
                    <label for="number3">Number 3:</label>
                    <input type="number" id="number3" name="number3" 
                           required min="1" max="37">
                </div>
                <div class="form-group">
                    <label for="number4">Number 4:</label>
                    <input type="number" id="number4" name="number4" 
                           required min="1" max="37">
                </div>
                <div class="form-group">
                    <label for="number5">Number 5:</label>
                    <input type="number" id="number5" name="number5" 
                           required min="1" max="37">
                </div>
                <div class="form-group">
                    <label for="number6">Number 6:</label>
                    <input type="number" id="number6" name="number6" 
                           required min="1" max="37">
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3>Strong Number (1-7)</h3>
            <div class="form-group">
                <label for="strong_number">Strong Number:</label>
                <input type="number" id="strong_number" name="strong_number" 
                       required min="1" max="7">
            </div>
        </div>

        <div class="form-section password-section">
            <h3>üîí Authorization</h3>
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" name="password" 
                       required placeholder="Enter password to add result">
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Add Result</button>
            <a href="{{ url_for('index') }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
    // Set today's date as default
    document.getElementById('draw_date').valueAsDate = new Date();
    
    // Fetch latest result from official website
    function fetchLatestResult() {
        const statusDiv = document.getElementById('fetch-status');
        statusDiv.innerHTML = '<p style="color: #667eea;">‚è≥ Fetching latest result...</p>';
        
        fetch('/api/fetch_latest')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const result = data.data;
                    
                    // Fill the form
                    document.getElementById('draw_number').value = result.draw_number;
                    
                    // Parse and set date (DD/MM/YYYY to YYYY-MM-DD)
                    const dateParts = result.date.split('/');
                    const dateFormatted = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;
                    document.getElementById('draw_date').value = dateFormatted;
                    
                    // Fill numbers
                    result.numbers.forEach((num, index) => {
                        document.getElementById(`number${index + 1}`).value = num;
                    });
                    
                    document.getElementById('strong_number').value = result.strong_number;
                    
                    statusDiv.innerHTML = `<p style="color: #28a745;">‚úì Successfully fetched Draw #${result.draw_number} (${result.date})</p>`;
                } else {
                    statusDiv.innerHTML = '<p style="color: #dc3545;">‚úó Failed to fetch result. Please enter manually.</p>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                statusDiv.innerHTML = '<p style="color: #dc3545;">‚úó Error fetching result. Please enter manually.</p>';
            });
    }
</script>
{% endblock %}


