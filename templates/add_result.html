{% extends "base.html" %}

{% block title %}Add Result - Israeli Lottery Predictor{% endblock %}

{% block content %}
<div class="section">
    <h1>Add New Lottery Result</h1>
    
    {% if success %}
    <div class="alert success">
        ‚úì {{ message }}
    </div>
    {% endif %}
    
    {% if error %}
    <div class="alert error">
        ‚úó {{ message }}
    </div>
    {% endif %}

    <div class="fetch-section">
        <h3>üåê Auto-Import Results</h3>
        <p>Automatically import lottery results from <a href="https://lottosheli.co.il/results/lotto" target="_blank">lottosheli.co.il</a></p>
        
        <div style="margin-bottom: 1rem;">
            <button type="button" class="btn btn-secondary" onclick="checkMissing()">Check Missing Results</button>
            <button type="button" class="btn btn-secondary" onclick="fetchLatestResult()">Fetch Latest to Form</button>
        </div>
        
        <div id="missing-info" style="display: none; margin-top: 1rem;">
            <div id="missing-summary"></div>
            <div style="margin-top: 1rem;">
                <label for="import-password" style="display: block; margin-bottom: 0.5rem;">Password to import:</label>
                <input type="password" id="import-password" placeholder="Enter password" 
                       style="padding: 8px; border: 2px solid #17a2b8; border-radius: 5px; width: 200px; margin-right: 10px;">
                <button type="button" class="btn btn-primary" onclick="importMissing()">Import Latest Draw Only</button>
            </div>
        </div>
        
        <div id="fetch-status"></div>
    </div>

    <div class="fetch-section" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-color: #4caf50;">
        <h3 style="color: #1b5e20;">üìù Quick Fill for Specific Draw</h3>
        <p style="color: #2e7d32;">Enter a draw number to auto-fill the date in the form below</p>
        <p style="color: #856404; font-size: 0.9em;"><strong>Note:</strong> Due to website limitations, numbers must be entered manually. This only fills the draw # and date.</p>
        
        <div style="display: flex; gap: 10px; justify-content: center; align-items: center; flex-wrap: wrap; margin-top: 1rem;">
            <div>
                <label for="specific-draw" style="display: block; margin-bottom: 0.5rem; color: #1b5e20; font-weight: 600;">Draw Number:</label>
                <input type="number" id="specific-draw" placeholder="e.g., 3876" 
                       style="padding: 8px; border: 2px solid #4caf50; border-radius: 5px; width: 120px;" min="1">
            </div>
            <div style="margin-top: 1.5rem;">
                <button type="button" class="btn btn-primary" onclick="fillDrawInfo()">Fill Draw Info</button>
            </div>
        </div>
        
        <div id="specific-status" style="margin-top: 1rem;"></div>
    </div>

    <form method="POST" class="add-result-form" id="addResultForm">
        <div class="form-group">
            <label for="draw_number">Draw Number:</label>
            <input type="number" id="draw_number" name="draw_number" 
                   value="{{ next_draw }}" required min="1">
        </div>

        <div class="form-group">
            <label for="draw_date">Draw Date:</label>
            <input type="date" id="draw_date" name="draw_date" required>
        </div>

        <div class="form-section">
            <h3>Main Numbers (1-37)</h3>
            <div class="numbers-input-grid">
                <div class="form-group">
                    <label for="number1">Number 1:</label>
                    <input type="number" id="number1" name="number1" 
                           required min="1" max="37">
                </div>
                <div class="form-group">
                    <label for="number2">Number 2:</label>
                    <input type="number" id="number2" name="number2" 
                           required min="1" max="37">
                </div>
                <div class="form-group">
                    <label for="number3">Number 3:</label>
                    <input type="number" id="number3" name="number3" 
                           required min="1" max="37">
                </div>
                <div class="form-group">
                    <label for="number4">Number 4:</label>
                    <input type="number" id="number4" name="number4" 
                           required min="1" max="37">
                </div>
                <div class="form-group">
                    <label for="number5">Number 5:</label>
                    <input type="number" id="number5" name="number5" 
                           required min="1" max="37">
                </div>
                <div class="form-group">
                    <label for="number6">Number 6:</label>
                    <input type="number" id="number6" name="number6" 
                           required min="1" max="37">
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3>Strong Number (1-7)</h3>
            <div class="form-group">
                <label for="strong_number">Strong Number:</label>
                <input type="number" id="strong_number" name="strong_number" 
                       required min="1" max="7">
            </div>
        </div>

        <div class="form-section password-section">
            <h3>üîí Authorization</h3>
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" name="password" 
                       required placeholder="Enter password to add result">
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Add Result</button>
            <a href="{{ url_for('index') }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
    // Set today's date as default
    document.getElementById('draw_date').valueAsDate = new Date();
    
    // Check for missing draws
    function checkMissing() {
        const statusDiv = document.getElementById('fetch-status');
        const missingInfo = document.getElementById('missing-info');
        const missingSummary = document.getElementById('missing-summary');
        
        statusDiv.innerHTML = '<p style="color: #667eea;">‚è≥ Checking for missing results...</p>';
        missingInfo.style.display = 'none';
        
        fetch('/api/check_missing')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.count === 0) {
                        statusDiv.innerHTML = '<p style="color: #28a745;">‚úì No missing draws! Your database is up to date.</p>';
                    } else {
                        statusDiv.innerHTML = '';
                        missingSummary.innerHTML = `
                            <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; border: 2px solid #ffc107;">
                                <h4 style="color: #856404; margin-top: 0;">‚ö†Ô∏è Missing ${data.count} Draw(s)</h4>
                                <p style="color: #856404;">Last in database: Draw #${data.latest_in_db}</p>
                                <p style="color: #856404;">Latest online: Draw #${data.latest_online}</p>
                                <p style="color: #856404;"><strong>Missing:</strong> ${data.missing_draws.join(', ')}</p>
                                <p style="color: #dc3545; font-size: 0.9em; margin-bottom: 0;">
                                    <strong>Important:</strong> The website only shows numbers for the latest draw. 
                                    Click below to import the latest, then manually enter the others using the form.
                                </p>
                            </div>
                        `;
                        missingInfo.style.display = 'block';
                    }
                } else {
                    statusDiv.innerHTML = '<p style="color: #dc3545;">‚úó Error checking missing draws.</p>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                statusDiv.innerHTML = '<p style="color: #dc3545;">‚úó Error checking missing draws.</p>';
            });
    }
    
    // Fill draw info (draw number and date only)
    function fillDrawInfo() {
        const drawNumber = document.getElementById('specific-draw').value;
        const statusDiv = document.getElementById('specific-status');
        
        if (!drawNumber) {
            statusDiv.innerHTML = '<p style="color: #dc3545;">‚úó Please enter a draw number.</p>';
            return;
        }
        
        statusDiv.innerHTML = `<p style="color: #667eea;">‚è≥ Fetching draw #${drawNumber} info...</p>`;
        
        fetch(`/get_draw_info?draw_number=${drawNumber}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Fill the form with draw number and date
                    document.getElementById('draw_number').value = data.draw_number;
                    
                    // Parse and set date
                    const dateParts = data.date.split('/');
                    const dateFormatted = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;
                    document.getElementById('draw_date').value = dateFormatted;
                    
                    statusDiv.innerHTML = `
                        <div style="background: #d4edda; padding: 1rem; border-radius: 8px; border: 2px solid #28a745;">
                            <p style="color: #155724; margin: 0;"><strong>‚úì Form filled with Draw #${data.draw_number} (${data.date})</strong></p>
                            <p style="color: #856404; margin: 0.5rem 0 0 0;">
                                Now enter the numbers manually and submit below. 
                                Check <a href="https://lottosheli.co.il/results/lotto" target="_blank" style="color: #856404;">the website</a> for this draw's numbers.
                            </p>
                        </div>
                    `;
                    
                    // Scroll to the form
                    document.getElementById('addResultForm').scrollIntoView({ behavior: 'smooth' });
                    
                    // Clear the input
                    document.getElementById('specific-draw').value = '';
                } else {
                    statusDiv.innerHTML = `<p style="color: #dc3545;">‚úó ${data.error}</p>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                statusDiv.innerHTML = '<p style="color: #dc3545;">‚úó Error fetching draw info.</p>';
            });
    }
    
    // Import missing draws
    function importMissing() {
        const password = document.getElementById('import-password').value;
        const statusDiv = document.getElementById('fetch-status');
        
        if (!password) {
            statusDiv.innerHTML = '<p style="color: #dc3545;">‚úó Please enter password.</p>';
            return;
        }
        
        statusDiv.innerHTML = '<p style="color: #667eea;">‚è≥ Importing latest draw...</p>';
        
        const formData = new FormData();
        formData.append('password', password);
        
        fetch('/import_missing', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let message = `<p style="color: #28a745;">‚úì ${data.message}</p>`;
                    if (data.imported && data.imported.length > 0) {
                        message += `<p style="color: #28a745;"><strong>Imported:</strong> Draw #${data.imported.join(', #')}</p>`;
                    }
                    if (data.still_missing && data.still_missing.length > 0) {
                        message += `<p style="color: #ffc107;"><strong>Still need manual entry:</strong> Draw #${data.still_missing.join(', #')}</p>`;
                        message += `<p style="color: #666; font-size: 0.9em;">Use "Quick Fill for Specific Draw" below to help with manual entry.</p>`;
                    }
                    statusDiv.innerHTML = message;
                    
                    // Refresh the missing check after 2 seconds
                    setTimeout(checkMissing, 2000);
                } else {
                    statusDiv.innerHTML = `<p style="color: #dc3545;">‚úó ${data.error}</p>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                statusDiv.innerHTML = '<p style="color: #dc3545;">‚úó Error importing draws.</p>';
            });
    }
    
    // Fetch latest result from official website (manual form fill)
    function fetchLatestResult() {
        const statusDiv = document.getElementById('fetch-status');
        statusDiv.innerHTML = '<p style="color: #667eea;">‚è≥ Fetching latest result...</p>';
        
        fetch('/api/fetch_latest')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const result = data.data;
                    
                    // Fill the form
                    document.getElementById('draw_number').value = result.draw_number;
                    
                    // Parse and set date (DD/MM/YYYY to YYYY-MM-DD)
                    const dateParts = result.date.split('/');
                    const dateFormatted = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;
                    document.getElementById('draw_date').value = dateFormatted;
                    
                    // Fill numbers
                    result.numbers.forEach((num, index) => {
                        document.getElementById(`number${index + 1}`).value = num;
                    });
                    
                    document.getElementById('strong_number').value = result.strong_number;
                    
                    statusDiv.innerHTML = `<p style="color: #28a745;">‚úì Form filled with Draw #${result.draw_number} (${result.date}). Enter password below to save.</p>`;
                    
                    // Scroll to the form
                    document.getElementById('addResultForm').scrollIntoView({ behavior: 'smooth' });
                } else {
                    statusDiv.innerHTML = '<p style="color: #dc3545;">‚úó Failed to fetch result. Please enter manually.</p>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                statusDiv.innerHTML = '<p style="color: #dc3545;">‚úó Error fetching result. Please enter manually.</p>';
            });
    }
</script>
{% endblock %}


